---
type Props = {
  defaultTheme?: 'auto' | 'dark' | 'light' | undefined
}

const { defaultTheme = 'auto' } = Astro.props
---

<script is:inline data-default-theme={defaultTheme}>
  window.theme ??= (() => {
    const defaultTheme = document.currentScript.getAttribute('data-default-theme')
    const storageKey = 'starlight-theme'
    const store = typeof localStorage !== 'undefined' ? localStorage : { getItem: () => null, setItem: () => {} }

    const mediaMatcher = window.matchMedia('(prefers-color-scheme: light)')
    let systemTheme = mediaMatcher.matches ? 'light' : 'dark'
    mediaMatcher.addEventListener('change', (event) => {
      systemTheme = event.matches ? 'light' : 'dark'
      applyTheme(theme.getTheme())
    })

    // eslint-disable-next-line ts/explicit-function-return-type
    function applyTheme(theme) {
      const resolved = theme === 'auto' ? systemTheme : theme
      const html = document.documentElement

      html.dataset.theme = resolved
      html.classList.remove('light', 'dark')
      html.classList.add(resolved)
      html.style.colorScheme = resolved

      document.dispatchEvent(
        new CustomEvent('theme-changed', {
          detail: { theme, systemTheme, defaultTheme },
        }),
      )
    }

    // eslint-disable-next-line ts/explicit-function-return-type
    function setTheme(theme = defaultTheme) {
      store.setItem(storageKey, theme)
      applyTheme(theme)
    }

    // eslint-disable-next-line ts/explicit-function-return-type
    function getTheme() {
      return store.getItem(storageKey) || defaultTheme
    }

    // eslint-disable-next-line ts/explicit-function-return-type
    function getSystemTheme() {
      return systemTheme
    }

    // eslint-disable-next-line ts/explicit-function-return-type
    function getDefaultTheme() {
      return defaultTheme
    }

    return { setTheme, getTheme, getSystemTheme, getDefaultTheme }
  })()

  theme.setTheme(theme.getTheme())
</script>

<script>
  document.addEventListener('astro:after-swap', () => window.theme.setTheme(window.theme.getTheme()))
</script>
