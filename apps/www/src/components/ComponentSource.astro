---
import { Index } from '@/registry/__index__'
import { readFileSync } from 'node:fs'
import { highlightCode } from '@/lib/highlight-code'
import ComponentCode from './ComponentCode.astro'
import { ComponentSource as ComponentSourceComponent } from './ComponentSource'
export interface Props {
  name?: string
  src?: string
  title?: string
  language?: string
  collapsible?: boolean
}

const { name, language, title, collapsible = true } = Astro.props

function updateImportsInSource(code: string, aliases: Record<string, string>) {
  code = code.replace(/import\s+([\s\S]*?)from\s+['"]@\/registry\/[^/]+\/ui\/(.+?)['"]/g, (match, imports, subpath) => `import ${imports}from '${aliases.ui}/${subpath}'`)
  code = code.replace(/import\s+([\s\S]*?)from\s+['"]@\/registry\/[^/]+\/components\/(.+?)['"]/g, (match, imports, subpath) => `import ${imports}from '${aliases.components}/${subpath}'`)
  code = code.replace(/import\s+([\s\S]*?)from\s+['"]@\/registry\/[^/]+\/lib\/(.+?)['"]/g, (match, imports, subpath) => `import ${imports}from '${aliases.lib}/${subpath}'`)
  code = code.replace(/import\s+([\s\S]*?)from\s+['"]@\/registry\/[^/]+\/hooks\/(.+?)['"]/g, (match, imports, subpath) => `import ${imports}from '${aliases.hooks}/${subpath}'`)

  return code
}

const aliases = {
  components: '@/components',
  ui: '@/components/ui',
  lib: '@/lib',
  hooks: '@/hooks',
}

const item = Index[name!]
const path = item.files[0].path

let code = readFileSync(path, 'utf-8').trim()
code = updateImportsInSource(code, aliases)

const lang = language ?? title?.split('.').pop() ?? 'angular-ts'
const highlightedCode = await highlightCode(code, lang)
---

<ComponentSourceComponent title={title} language={lang} highlightedCode={highlightedCode} code={code} collapsible={collapsible} client:visible />
